name: CI Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkout lcod-spec
        uses: actions/checkout@v4
        with:
          repository: lcod-team/lcod-spec
          path: spec
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Install dependencies
        run: npm ci
      - name: Install CLI (lcod)
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -fsSL https://raw.githubusercontent.com/lcod-team/lcod-cli/main/dist/lcod -o "$HOME/.local/bin/lcod"
          chmod +x "$HOME/.local/bin/lcod"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          lcod version
      - name: Install kernels
        env:
          LCOD_DISABLE_AUTO_UPDATE: "1"
        run: |
          lcod kernel install rs --version 0.1.21 --force
          lcod kernel install java --version 0.1.21 --force
      - name: Run component tests
        env:
          SPEC_REPO_PATH: ${{ github.workspace }}/spec
        run: npm test

  verify-components:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkout lcod-spec
        uses: actions/checkout@v4
        with:
          repository: lcod-team/lcod-spec
          path: spec
      - name: Install dependencies
        run: npm ci
      - name: Check runtime overlap
        run: npm run check:runtime
      - name: Ensure components manifest is current
        run: |
          npm run export:components
          git diff --exit-code registry/components.std.jsonl
